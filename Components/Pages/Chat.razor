
@page "/chat"
@using CrossTenantChat.Models
@using CrossTenantChat.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IAzureCommunicationService AcsService
@inject IEntraIdAuthenticationService AuthService
@inject ILogger<Chat> Logger
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IConfiguration Configuration
@using System.Text.RegularExpressions
@implements IDisposable
@attribute [AllowAnonymous]
@rendermode InteractiveServer

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="text-primary mb-4">
                üåê Cross-Tenant Chat Demo
                <small class="text-muted">Azure Communication Services + Microsoft Entra ID</small>
            </h1>
        </div>
    </div>

    @if (currentUser == null && !isLoading)
    {
        <div class="row">
            <div class="col-12 text-center">
                <div class="alert alert-warning">
                    <h4>üîê Authentication Required</h4>
                    <p>Please log in to access the cross-tenant chat demo.</p>
                    <a href="/login" class="btn btn-primary">Go to Login</a>
                </div>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div class="row">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Initializing authentication...</p>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <!-- User Info Panel -->
            <div class="col-md-3">
                <div class="card mb-3 @(currentUser?.IsFromFabrikam == true ? "border-warning" : "border-info")">
                    <div class="card-header @(currentUser?.IsFromFabrikam == true ? "bg-warning" : "bg-info") text-white">
                        <h6 class="mb-0">
                            @(currentUser?.IsFromFabrikam == true ? "üåê Cross-Tenant User" : "üè¢ Local User")
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>@currentUser?.Name</strong></p>
                        <p class="mb-1 text-muted small">@currentUser?.Email</p>
                        <p class="mb-1"><span class="badge @(currentUser?.IsFromFabrikam == true ? "bg-warning" : "bg-info")">@currentUser?.TenantName</span></p>
                        
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">üí¨ Chat Threads</h6>
                    </div>
                    <div class="card-body">
                        @if (userThreads.Any())
                        {
                            @foreach (var thread in userThreads)
                            {
                                <div class="mb-2">
                                    <button class="btn btn-outline-primary btn-sm w-100 text-start" 
                                            @onclick="() => SelectThread(thread.Id)">
                                        @if (thread.IsCrossTenant)
                                        {
                                            <span>üåê</span>
                                        }
                                        @thread.Topic
                                    </button>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted small">No chat threads yet</p>
                        }
                        
                        <button class="btn btn-success btn-sm w-100 mt-2" @onclick="ShowNewThreadModal">
                            ‚ûï New Thread
                        </button>

                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="col-md-9">
                @if (!string.IsNullOrEmpty(selectedThreadId))
                {
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                @if (selectedThread?.IsCrossTenant == true)
                                {
                                    <span>üåê</span>
                                }
                                @selectedThread?.Topic
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="RefreshMessages">
                                üîÑ Refresh
                            </button>
                        </div>
                        <div class="card-body d-flex flex-column" style="height: 500px;">
                            <!-- Messages -->
                            <div class="flex-grow-1 overflow-auto mb-3" style="max-height: 400px;">
                                @if (currentMessages.Any())
                                {
                                    @foreach (var message in currentMessages)
                                    {
                                        <div class="mb-2 p-2 rounded @GetMessageCssClass(message)">
                                            <div class="small text-muted">
                                                <strong>@message.SenderName</strong>
                                                @if (!string.IsNullOrEmpty(message.SenderTenant) && message.SenderTenant != "System")
                                                {
                                                    <span class="badge @(message.SenderTenant == "Fabrikam" ? "bg-warning" : "bg-info") ms-1">
                                                        @message.SenderTenant
                                                    </span>
                                                }
                                                <span class="ms-2">@message.Timestamp.ToString("HH:mm:ss")</span>
                                            </div>
                                            <div>
                                                @if (message.Type == MessageType.Text && message.SenderTenant == "Fabrikam")
                                                {
                                                    <span title="Cross-tenant message">üåê </span>
                                                }
                                                @SanitizeMessageContent(message)
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted text-center">No messages yet. Start the conversation!</p>
                                }
                            </div>

                            <!-- Message Input: submit on Enter -->
                            <form @onsubmit="OnSubmitSend" @onsubmit:preventDefault="true">
                                <div class="input-group">
                                    <input type="text" class="form-control" @bind="newMessage"
                                           placeholder="Type your message..." disabled="@isSendingMessage">
                                    <button type="submit" class="btn btn-primary" disabled="@(isSendingMessage || string.IsNullOrEmpty(newMessage))">
                                        @if (isSendingMessage)
                                        {
                                            <span class="spinner-border spinner-border-sm"></span>
                                        }
                                        else
                                        {
                                            <span>üì§ Send</span>
                                        }
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                }
                else
                {
                    <div class="card h-100">
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <div class="text-center text-muted">
                                <h3>üí¨</h3>
                                <p>Select a chat thread or create a new one to start messaging</p>
                            </div>
                        </div>
                    </div>
                }

                <!-- ACS Debug Panel placed below the chat area (right column bottom) as footer-style -->
                <AcsDebugPanel User="currentUser" Thread="selectedThread" InitiallyCollapsed="true" Inline="true" FooterStyle="true" />
            </div>
        </div>
    }
</div>

<!-- New Thread Modal -->
@if (showNewThreadModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üí¨ Create New Chat Thread</h5>
                    <button type="button" class="btn-close" @onclick="() => showNewThreadModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="threadTopic" class="form-label">Thread Topic:</label>
                        <input type="text" class="form-control" id="threadTopic" @bind="newThreadTopic" 
                               placeholder="Enter chat topic...">
                    </div>
                    @if (currentUser?.IsFromFabrikam == true)
                    {
                        <div class="alert alert-warning">
                            <strong>üåê Cross-Tenant Chat:</strong> 
                            This thread will be created by a Fabrikam user in Contoso's ACS resources.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showNewThreadModal = false">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="CreateNewThread" 
                            disabled="@(isCreatingThread || string.IsNullOrEmpty(newThreadTopic))">
                        @if (isCreatingThread)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Create Thread
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    public Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private ChatUser? currentUser;
    private bool isLoading = true;

    private List<ChatThread> userThreads = new();
    private string selectedThreadId = "";
    private ChatThread? selectedThread;
    private List<Models.ChatMessage> currentMessages = new();

    private string newMessage = "";
    private bool isSendingMessage = false;

    private bool showNewThreadModal = false;
    private string newThreadTopic = "";
    private bool isCreatingThread = false;

    // Auto-refresh settings
    [Parameter]
    public bool AutoRefreshEnabled { get; set; } = true;

    [Parameter]
    public int AutoRefreshIntervalMs { get; set; } = 1500; // 1.5s default for snappy updates

    private CancellationTokenSource? _refreshCts;
    private Task? _refreshTask;
    private bool _isRefreshing;
    private bool _isRefreshingThreads;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("üöÄ Cross-Tenant Chat Demo initialized");
        
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                Logger.LogInformation("‚úÖ User is authenticated, initializing user data");
                await InitializeAuthenticatedUser(authState.User);
            }
            else
            {
                Logger.LogInformation("‚ö†Ô∏è User is not authenticated");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error checking authentication state");
        }
        
        isLoading = false;
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        // React to sign-in/sign-out without requiring a full page reload
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;

        // Load optional configuration overrides
        try
        {
            var enabled = Configuration["Chat:AutoRefreshEnabled"];
            if (!string.IsNullOrWhiteSpace(enabled) && bool.TryParse(enabled, out var b))
            {
                AutoRefreshEnabled = b;
            }

            var interval = Configuration["Chat:AutoRefreshIntervalMs"];
            if (!string.IsNullOrWhiteSpace(interval) && int.TryParse(interval, out var ms) && ms >= 500 && ms <= 10000)
            {
                AutoRefreshIntervalMs = ms;
            }
        }
        catch { }
    }

    private void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        _ = InvokeAsync(async () =>
        {
            try
            {
                isLoading = true;
                StateHasChanged();

                var state = await task;
                if (state.User.Identity?.IsAuthenticated == true)
                {
                    Logger.LogInformation("üîÑ Auth state changed: user authenticated -> refreshing user profile");
                    await InitializeAuthenticatedUser(state.User);
                }
                else
                {
                    Logger.LogInformation("üîÑ Auth state changed: user signed out");
                    currentUser = null;
                    userThreads.Clear();
                    selectedThreadId = string.Empty;
                    selectedThread = null;
                    currentMessages.Clear();
                    StopAutoRefresh();
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error handling authentication state change");
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        });
    }

    private async Task InitializeAuthenticatedUser(ClaimsPrincipal user)
    {
        try
        {
            Logger.LogInformation("üîê Initializing authenticated user");

            // Extract user information from claims
            // Handle both demo and real authentication claim formats
            var nameIdentifier = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? 
                               user.FindFirst("oid")?.Value ?? 
                               user.FindFirst("sub")?.Value;
                               
            var name = user.FindFirst(ClaimTypes.Name)?.Value ?? 
                      user.FindFirst("name")?.Value ??
                      user.Identity?.Name ??
                      user.FindFirst("preferred_username")?.Value ??
                      user.FindFirst("upn")?.Value;
                      
            var email = user.FindFirst(ClaimTypes.Email)?.Value ?? 
                       user.FindFirst("preferred_username")?.Value ??
                       user.FindFirst("email")?.Value ??
                       user.FindFirst("upn")?.Value;
                       
            var tenantId = user.FindFirst("tid")?.Value ?? 
                          user.FindFirst("tenant_id")?.Value;
                          
            var tenant = user.FindFirst("tenant")?.Value;

            Logger.LogInformation("üìã Claims found - ID: {Id}, Name: {Name}, Email: {Email}, TenantId: {TenantId}, Tenant: {Tenant}", 
                nameIdentifier, name, email, tenantId, tenant);

            if (string.IsNullOrEmpty(nameIdentifier))
            {
                Logger.LogError("‚ùå No user identifier found in claims");
                return;
            }

            // Determine if this is a cross-tenant user based on tenant ID or tenant name
            var fabrikamTenantId = "307083d3-52ba-4934-a29a-97cefcedc6a6";
            
            bool isFromFabrikam = tenantId == fabrikamTenantId || tenant == "Fabrikam";
            string tenantName = isFromFabrikam ? "Fabrikam" : "Contoso";

            currentUser = new ChatUser
            {
                Id = nameIdentifier,
                Name = string.IsNullOrWhiteSpace(name) ? (email ?? "Unknown User") : name,
                Email = email ?? "",
                TenantId = tenantId ?? "",
                TenantName = tenantName,
                IsFromFabrikam = isFromFabrikam,
                AccessToken = "" // Will be populated by token exchange
            };

            Logger.LogInformation("‚úÖ User initialized: {UserName} from {TenantName} ({TenantId})", 
                currentUser.Name, tenantName, tenantId);

            // Perform token exchange for ACS access
            await ExchangeTokenForAcs();

            // Load user's chat threads
            await RefreshUserThreads();

            // Do not auto-create or auto-select a default thread.
            // Require the user to explicitly create or choose a thread.
            if (userThreads.Count == 0)
            {
                // Prompt user to create a thread if none exist
                showNewThreadModal = true;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error initializing authenticated user");
        }
    }

    private async Task ExchangeTokenForAcs()
    {
        if (currentUser == null) return;

        try
        {
            Logger.LogInformation("üîÑ Exchanging token for ACS access");

            // In a real implementation, you would get the actual access token from the authentication context
            // For now, we'll simulate this with the available user claims
            var tokenResult = await AcsService.ExchangeEntraIdTokenForAcsTokenAsync(currentUser);

            if (!tokenResult.IsSuccess)
            {
                Logger.LogError("‚ùå ACS token exchange failed: {Error}", tokenResult.ErrorMessage);
                return;
            }

            Logger.LogInformation("‚úÖ ACS token exchange successful");

            // Store expiry for debug panel
            currentUser.TokenExpiry = tokenResult.ExpiresOn;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error during ACS token exchange");
        }
    }

    private async Task RefreshUserThreads()
    {
        if (currentUser == null) return;

        if (_isRefreshingThreads) return;
        _isRefreshingThreads = true;
        try
        {
            var threads = await AcsService.GetUserChatThreadsAsync(currentUser);
            userThreads = threads;

            // Keep selectedThread reference fresh if it's still present
            if (!string.IsNullOrEmpty(selectedThreadId))
            {
                selectedThread = userThreads.FirstOrDefault(t => t.Id == selectedThreadId);
                // If the selected thread disappeared, clear selection
                if (selectedThread == null)
                {
                    selectedThreadId = string.Empty;
                    currentMessages.Clear();
                }
            }

            StateHasChanged();
        }
        finally
        {
            _isRefreshingThreads = false;
        }
    }

    private async Task SelectThread(string threadId)
    {
        selectedThreadId = threadId;
        selectedThread = userThreads.FirstOrDefault(t => t.Id == threadId);
        await RefreshMessages();
    StartAutoRefresh();
    }

    private async Task RefreshMessages()
    {
        if (!string.IsNullOrEmpty(selectedThreadId))
        {
            // Guard against overlapping refreshes
            if (_isRefreshing) return;
            _isRefreshing = true;
            try
            {
                currentMessages = await AcsService.GetMessagesAsync(selectedThreadId);
                StateHasChanged();
            }
            finally
            {
                _isRefreshing = false;
            }
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrEmpty(newMessage) || currentUser == null || string.IsNullOrEmpty(selectedThreadId))
            return;

        isSendingMessage = true;
        StateHasChanged();

        try
        {
            var success = await AcsService.SendMessageAsync(selectedThreadId, newMessage, currentUser);
            if (success)
            {
                newMessage = "";
                await RefreshMessages();
            }
        }
        finally
        {
            isSendingMessage = false;
            StateHasChanged();
        }
    }

    private async Task OnSubmitSend()
    {
        // Submitting the form (e.g., pressing Enter) should send the message
        await SendMessage();
    }

    private void ShowNewThreadModal()
    {
        showNewThreadModal = true;
        newThreadTopic = "";
    }

    private async Task CreateNewThread()
    {
        if (string.IsNullOrEmpty(newThreadTopic) || currentUser == null)
            return;

        isCreatingThread = true;
        StateHasChanged();

        try
        {
            // Create explicitly-named thread; caching layer will store/reuse for the user.
            var newThread = await AcsService.CreateChatThreadAsync(newThreadTopic, new[] { currentUser.Id });
            await RefreshUserThreads();
            
            selectedThreadId = newThread.Id;
            selectedThread = newThread;
            await RefreshMessages();

            showNewThreadModal = false;
            StartAutoRefresh();
        }
        finally
        {
            isCreatingThread = false;
            StateHasChanged();
        }
    }

    private string GetMessageCssClass(Models.ChatMessage message)
    {
        return message.Type switch
        {
            MessageType.System => "bg-light border-start border-5 border-info",
            MessageType.CrossTenantInfo => "bg-warning-subtle border-start border-5 border-warning",
            _ when message.SenderTenant == "Fabrikam" => "bg-warning-subtle",
            _ => "bg-light"
        };
    }

    public void Dispose()
    {
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        StopAutoRefresh();
    }

    private void StartAutoRefresh()
    {
        // Cancel any existing loop
        StopAutoRefresh();

        if (!AutoRefreshEnabled || string.IsNullOrEmpty(selectedThreadId))
            return;

        _refreshCts = new CancellationTokenSource();
        var token = _refreshCts.Token;

        _refreshTask = Task.Run(async () =>
        {
            try
            {
                // Small initial delay to avoid immediate back-to-back fetch after manual refresh
                await Task.Delay(AutoRefreshIntervalMs, token);
                while (!token.IsCancellationRequested)
                {
                    try
                    {
                        // Always check for newly created threads
                        if (AutoRefreshEnabled)
                        {
                            await InvokeAsync(RefreshUserThreads);
                        }

                        // Then refresh messages for the selected thread, if any
                        if (!string.IsNullOrEmpty(selectedThreadId) && AutoRefreshEnabled)
                        {
                            await InvokeAsync(RefreshMessages);
                        }
                    }
                    catch
                    {
                        // Swallow per-iteration errors to keep loop alive; they are logged in RefreshMessages
                    }

                    await Task.Delay(AutoRefreshIntervalMs, token);
                }
            }
            catch (TaskCanceledException)
            {
                // expected on cancel
            }
        }, token);
    }

    private void StopAutoRefresh()
    {
        try
        {
            _refreshCts?.Cancel();
        }
        catch { }
        finally
        {
            _refreshCts?.Dispose();
            _refreshCts = null;
            _refreshTask = null;
        }
    }

    // Remove any legacy-leading globe icons that may have been persisted into message content
    // by earlier versions of the app. Keeps display idempotent while the UI adds a single icon.
    private string SanitizeMessageContent(Models.ChatMessage message)
    {
        var content = message.Content ?? string.Empty;
        // Strip any number of "üåê" with optional surrounding spaces at the start
        return Regex.Replace(content, @"^(?:\s*üåê\s*)+", string.Empty);
    }
}

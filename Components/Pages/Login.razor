@page "/login"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.OpenIdConnect
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@inject NavigationManager Navigation
@inject ILogger<Login> Logger
@inject IJSRuntime JSRuntime
@attribute [AllowAnonymous]

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card modern-login-card">
                <div class="card-header modern-login-header">
                    <div class="login-icon-large">ğŸ”</div>
                    <h3 class="mb-2">Cross-Tenant Authentication</h3>
                    <p class="mb-0 header-subtitle">Azure Communication Services + Microsoft Entra ID</p>
                </div>
                <div class="card-body modern-login-body">
                    <h5 class="mb-4 text-center tenant-selection-title">Select Your Tenant</h5>
                    
                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="alert modern-alert">
                            <div class="alert-icon">â„¹ï¸</div>
                            <div>
                                <strong>Status:</strong> @statusMessage
                            </div>
                        </div>
                    }
                    
                    <div class="tenant-cards-container">
                        <div class="tenant-card modern-tenant-card fabrikam-card">
                            <div class="tenant-card-header">
                                <div class="tenant-emoji">ğŸ¢</div>
                                <div class="tenant-details">
                                    <h6 class="tenant-title">Fabrikam Corp</h6>
                                    <p class="tenant-subtitle">Cross-tenant user authentication</p>
                                </div>
                            </div>
                            <div class="tenant-card-body">
                                <a href="/challenge/oidc?tenant=Fabrikam&returnUrl=@Uri.EscapeDataString(GetReturnUrl())" 
                                   class="btn modern-btn btn-fabrikam">
                                    <span class="btn-icon">ğŸŒ</span>
                                    Login with Fabrikam
                                </a>
                            </div>
                        </div>
                        
                        <div class="tenant-card modern-tenant-card contoso-card">
                            <div class="tenant-card-header">
                                <div class="tenant-emoji">ğŸ›ï¸</div>
                                <div class="tenant-details">
                                    <h6 class="tenant-title">Contoso Ltd</h6>
                                    <p class="tenant-subtitle">ACS resource owner</p>
                                </div>
                            </div>
                            <div class="tenant-card-body">
                                <a href="/challenge/oidc?tenant=Contoso&returnUrl=@Uri.EscapeDataString(GetReturnUrl())" 
                                   class="btn modern-btn btn-contoso">
                                    <span class="btn-icon">ğŸ¢</span>
                                    Login with Contoso
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="demo-info-modern">
                        <div class="demo-info-header">
                            <span class="demo-info-icon">ğŸ’¡</span>
                            <strong>Demo Information</strong>
                        </div>
                        <div class="demo-info-content">
                            <p>Choose <strong>Fabrikam</strong> to demonstrate cross-tenant authentication, or <strong>Contoso</strong> for local tenant authentication.</p>
                            <small>Try the main buttons first, then the test buttons if needed.</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Debug Information -->
            @if (debugMessages.Any())
            {
                <div class="card mt-4 debug-card-modern">
                    <div class="card-header debug-header-modern">
                        <div class="debug-title-container">
                            <span class="debug-icon">ğŸ”</span>
                            <h6 class="mb-0">Debug Information</h6>
                        </div>
                        <button class="btn btn-sm modern-debug-btn" @onclick="ClearDebug">Clear</button>
                    </div>
                    <div class="card-body debug-body-modern">
                        <div class="debug-messages-modern">
                            @foreach (var msg in debugMessages.TakeLast(10))
                            {
                                <div class="debug-message-item">
                                    <span class="debug-timestamp">[@msg.Time.ToString("HH:mm:ss")]</span>
                                    <span class="debug-text">@msg.Message</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    private bool isProcessing = false;
    private string? selectedTenant = null;
    private string statusMessage = "";
    
    private List<DebugMessage> debugMessages = new();
    
    public class DebugMessage
    {
        public DateTime Time { get; set; } = DateTime.Now;
        public string Message { get; set; } = "";
    }

    private string GetReturnUrl()
    {
        return !string.IsNullOrEmpty(ReturnUrl) ? ReturnUrl : "/chat";
    }

    private void AddDebugMessage(string message)
    {
        debugMessages.Add(new DebugMessage { Message = message });
        InvokeAsync(StateHasChanged);
    }
    
    private void ClearDebug()
    {
        debugMessages.Clear();
        StateHasChanged();
    }

    private void TestClick(string tenant)
    {
        AddDebugMessage($"ğŸ§ª Test button clicked for {tenant}");
        Logger.LogInformation("ğŸ§ª Test button clicked for tenant: {Tenant}", tenant);
        statusMessage = $"Test button click registered for {tenant}!";
        StateHasChanged();
    }

    private async Task LoginWithTenant(string tenant)
    {
        if (isProcessing) 
        {
            AddDebugMessage("âš ï¸ Already processing, ignoring click");
            return;
        }
        
        isProcessing = true;
        selectedTenant = tenant;
        statusMessage = $"Initiating authentication with {tenant}...";
        StateHasChanged();
        
        AddDebugMessage($"ğŸš€ Login button clicked for tenant: {tenant}");
        Logger.LogInformation("ğŸš€ Initiating login for tenant: {Tenant}", tenant);
        
        try
        {
            AddDebugMessage("ğŸ“‹ Creating authentication properties...");
            
            // Set the tenant-specific authority based on selection
            if (tenant == "Fabrikam")
            {
                AddDebugMessage("ğŸ¢ Configuring Fabrikam tenant authentication");
            }
            else
            {
                AddDebugMessage("ğŸ›ï¸ Configuring Contoso tenant authentication");
            }
            
            string returnUrl = GetReturnUrl();
            AddDebugMessage($"ğŸ“ Return URL: {returnUrl}");
            
            var challengeUrl = $"/challenge/oidc?tenant={tenant}&returnUrl={Uri.EscapeDataString(returnUrl)}";
            AddDebugMessage($"ğŸŒ Challenge URL: {challengeUrl}");
            
            statusMessage = $"Redirecting to {tenant} authentication...";
            StateHasChanged();
            
            // Add a small delay to show the loading state
            await Task.Delay(100);
            
            AddDebugMessage("âœ… Initiating navigation with forceLoad=true");
            
            // Log the navigation attempt
            Logger.LogInformation("ğŸŒ Navigating to challenge URL: {ChallengeUrl}", challengeUrl);
            
            // Use JavaScript to navigate to avoid Blazor routing issues
            await JSRuntime.InvokeVoidAsync("window.location.assign", challengeUrl);
        }
        catch (Exception ex)
        {
            AddDebugMessage($"âŒ Error during login process: {ex.Message}");
            Logger.LogError(ex, "âŒ Error during login process for tenant {Tenant}", tenant);
            statusMessage = $"Error: {ex.Message}";
        }
        finally
        {
            // Don't reset these immediately as we're navigating away
            // isProcessing = false;
            // selectedTenant = null;
        }
    }

    protected override void OnInitialized()
    {
        Logger.LogInformation("ğŸ¨ Login page initialized with ReturnUrl: {ReturnUrl}", ReturnUrl ?? "null");
        AddDebugMessage($"ğŸ¨ Login page initialized");
        AddDebugMessage($"ğŸ“ Return URL parameter: {ReturnUrl ?? "not provided"}");
        AddDebugMessage($"ğŸŒ Current URL: {Navigation.Uri}");
    }
}